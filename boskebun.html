<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroCore - Owner Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #10b981; --bg: #f1f5f9; --white: #ffffff; --text: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; }
        .brand { font-size: 22px; font-weight: bold; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.3s; color: #94a3b8; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { border-left: 4px solid var(--accent); color: white; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 50px; height: 50px; background: #e2e8f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--primary); }
        .table-card { background: var(--white); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; color: #64748b; font-size: 0.85em; padding: 10px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 15px 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.95em; }
        
        /* CCTV GRID STYLE (DIPERBAIKI) */
        .cctv-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .cctv-frame { background: black; height: 280px; border-radius: 10px; position: relative; overflow: hidden; border: 2px solid #333; }
        .cctv-frame img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.5s; }
        .cctv-frame:hover img { opacity: 1; transform: scale(1.05); }
        .cctv-overlay { position: absolute; top: 15px; left: 15px; color: white; background: red; padding: 3px 10px; border-radius: 4px; font-size: 0.8em; animation: blink 1.5s infinite; z-index: 10; font-weight: bold; box-shadow: 0 0 5px red; }
        .cctv-label { position: absolute; bottom: 15px; left: 15px; color: #0f0; font-family: monospace; background: rgba(0,0,0,0.7); padding: 2px 5px; font-size: 0.9em; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: white; width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 15px; padding: 25px; animation: slideUp 0.3s; }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .bg-pending { background: #fef3c7; color: #b45309; }
        .bg-paid { background: #dcfce7; color: #166534; }
        .btn-view { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 5px; font-size: 0.9em; }
        .btn-pay { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .gallery-grid img { width: 100%; height: 120px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
        .map-container { position: relative; height: 400px; background-color: #e5e7eb; border-radius: 12px; overflow: hidden; background-image: radial-gradient(#9ca3af 1px, transparent 1px); background-size: 20px 20px; }
        .sector-zone { position: absolute; border: 2px dashed rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 2em; color: rgba(0,0,0,0.1); }
        .worker-dot { position: absolute; width: 40px; height: 40px; background: var(--accent); border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2em; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.5s; z-index: 10; cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><i class="fa-solid fa-building-wheat"></i> AgroCore Owner</div>
        <div class="menu-item active" onclick="showPage('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
        <div class="menu-item" onclick="showPage('map', this)"><i class="fa-solid fa-map-location-dot"></i> Peta & GPS</div>
        <div class="menu-item" onclick="showPage('cctv', this)"><i class="fa-solid fa-video"></i> Monitoring CCTV</div>
        <div class="menu-item" onclick="showPage('finance', this)"><i class="fa-solid fa-wallet"></i> Keuangan</div>
        <div class="menu-item" onclick="showPage('report', this)"><i class="fa-solid fa-file-invoice"></i> Laporan Panen</div>
    </div>

    <div class="main">
        <div class="top-bar">
            <h2 id="page-title">Dashboard Perkebunan</h2>
            <div style="text-align: right;">
                <div style="font-weight: bold;">Pemilik: Bpk. Wijaya</div>
                <small id="last-sync">Syncing...</small>
                <button onclick="resetDB()" style="margin-left:10px; font-size:0.7em; padding:3px 8px; cursor:pointer;">Reset Data</button>
            </div>
        </div>

        <div id="dashboard" class="page-section active">
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                    <div style="font-size: 2em;"><i class="fa-solid fa-cloud-sun"></i></div>
                    <div><h4>Cuaca Lahan</h4><h2>Cerah, 29°C</h2></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: green;"><i class="fa-solid fa-leaf"></i></div>
                    <div><h4>Prediksi Panen</h4><h2>Sektor A: 2 Hari</h2></div>
                </div>
                 <div class="stat-card">
                    <div class="stat-icon" style="color: orange;"><i class="fa-solid fa-trowel"></i></div>
                    <div><h4>Perawatan</h4><h2>Sektor B: Pupuk</h2></div>
                </div>
            </div>

            <div class="table-card">
                <h3>Laporan Aktivitas Harian (Real-time)</h3>
                <table style="width:100%">
                    <thead><tr><th>Nama</th><th>Sektor</th><th>Detail Pekerjaan</th><th>Upah</th><th>Status</th><th>Aksi</th></tr></thead>
                    <tbody id="live-table-body"></tbody>
                </table>
                <p id="empty-msg" style="text-align:center; color:gray; padding:20px;">Belum ada laporan masuk.</p>
            </div>
        </div>

        <div id="map" class="page-section">
            <div class="table-card">
                <h3><i class="fa-solid fa-satellite"></i> Pelacakan GPS Buruh</h3>
                <div class="map-container" id="farm-map">
                    <div class="sector-zone" style="top:0; left:0; width:50%; height:100%; background:rgba(16, 185, 129, 0.1);">SEKTOR A</div>
                    <div class="sector-zone" style="top:0; right:0; width:50%; height:50%; background:rgba(59, 130, 246, 0.1);">SEKTOR B</div>
                    <div class="sector-zone" style="bottom:0; right:0; width:50%; height:50%; background:rgba(245, 158, 11, 0.1);">SEKTOR C</div>
                </div>
            </div>
        </div>

        <div id="cctv" class="page-section">
             <div class="table-card">
                <h3><i class="fa-solid fa-video"></i> CCTV Monitoring (Live Feed)</h3>
                <div class="cctv-grid">
                    <div class="cctv-frame">
                        <img src="https://loremflickr.com/400/300/farmer,field?random=1" alt="CCTV 1">
                        <div class="cctv-overlay">REC •</div>
                        <div class="cctv-label">CAM 01 - SEKTOR A (UTARA)</div>
                    </div>
                    <div class="cctv-frame">
                        <img src="https://loremflickr.com/400/300/gardening,worker?random=2" alt="CCTV 2">
                        <div class="cctv-overlay">REC •</div>
                        <div class="cctv-label">CAM 02 - SEKTOR B (SELATAN)</div>
                    </div>
                    <div class="cctv-frame">
                        <img src="https://loremflickr.com/400/300/agriculture,harvest?random=3" alt="CCTV 3">
                        <div class="cctv-overlay">REC •</div>
                        <div class="cctv-label">CAM 03 - SEKTOR C (BARAT)</div>
                    </div>
                    <div class="cctv-frame">
                        <img src="https://loremflickr.com/400/300/farm,people?random=4" alt="CCTV 4">
                        <div class="cctv-overlay">REC •</div>
                        <div class="cctv-label">CAM 04 - GUDANG PENYIMPANAN</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="finance" class="page-section">
            <div class="table-card">
                <h3><i class="fa-solid fa-chart-line"></i> Arus Kas</h3>
                <div style="padding: 15px 0; border-bottom: 1px dashed #ccc;">
                    <span>Pengeluaran Gaji Real-time</span>
                    <span style="float:right; color: red; font-weight:bold;" id="finance-wage">- Rp 0</span>
                </div>
                <div style="padding: 15px 0; border-bottom: 1px dashed #ccc;">
                    <span>Pemasukan Penjualan</span>
                    <span style="float:right; color: green; font-weight:bold;">+ Rp 65.000.000</span>
                </div>
            </div>
        </div>

        <div id="report" class="page-section">
            <div class="table-card">
                <h3><i class="fa-solid fa-sack-dollar"></i> Riwayat Penjualan</h3>
                <table style="width:100%">
                    <thead><tr><th>Periode</th><th>Komoditas</th><th>Berat</th><th>Pendapatan</th></tr></thead>
                    <tbody>
                        <tr><td>Minggu Lalu</td><td>Tomat Merah</td><td>1.0 Ton</td><td style="color:green;">+ Rp 20.000.000</td></tr>
                        <tr><td>Minggu Lalu</td><td>Cabai Rawit</td><td>500 Kg</td><td style="color:green;">+ Rp 45.000.000</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-card" style="margin-top:20px;">
                <h3><i class="fa-solid fa-list"></i> Log Harian Buruh</h3>
                <table style="width:100%"><tbody id="history-table-body"></tbody></table>
            </div>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <h3>Verifikasi Laporan</h3>
            <p id="modal-name">Nama Buruh</p>
            <p id="modal-sector">Sektor</p>
            <hr>
            <div id="modal-gallery" class="gallery-grid"></div>
            <button onclick="document.getElementById('detailModal').style.display='none'" style="margin-top:20px; padding: 10px; width: 100%; background: #333; color: white; border: none; cursor: pointer;">Tutup</button>
        </div>
    </div>

    <script>
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }

        // Helper untuk menampilkan ringkasan tugas
        function getTaskSummary(tasks) {
            let summary = [];
            if(tasks.pollination) summary.push(`Serbuk: ${tasks.pollination}`);
            if(tasks.cutting) summary.push(`Cut: ${tasks.cutting}`);
            if(tasks.harvest) summary.push(`Panen: ${tasks.harvest}`);
            if(tasks.hoeing) summary.push(`Cangkul: ${tasks.hoeing}`);
            if(tasks.pestcontrol) summary.push(`Pest: ${tasks.pestcontrol}`);
            if(tasks.fertilizer) summary.push(`Pupuk: ${tasks.fertilizer}`);
            return summary.length > 0 ? summary.join(', ') : "Hanya Absen";
        }

        function loadRealtimeData() {
            const rawData = localStorage.getItem('agroDB');
            const workers = rawData ? JSON.parse(rawData) : [];

            const tbodyDashboard = document.getElementById('live-table-body');
            const tbodyHistory = document.getElementById('history-table-body');
            const emptyMsg = document.getElementById('empty-msg');
            const mapContainer = document.getElementById('farm-map');

            const totalWage = workers.reduce((acc, curr) => acc + curr.salary, 0);
            document.getElementById('finance-wage').innerText = "- " + formatRupiah(totalWage);

            tbodyDashboard.innerHTML = '';
            tbodyHistory.innerHTML = '';
            
            // Clear Map Dots
            document.querySelectorAll('.worker-dot').forEach(dot => dot.remove());

            if (workers.length === 0) {
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                
                workers.slice().reverse().forEach((worker, index) => {
                    const realIndex = workers.length - 1 - index; 
                    
                    let statusBadge = worker.status === 'Pending' ? `<span class="badge bg-pending">Menunggu</span>` : `<span class="badge bg-paid">Lunas</span>`;
                    let actionButtons = worker.status === 'Pending'
                        ? `<button class="btn-view" onclick="openDetail(${realIndex})"><i class="fa-solid fa-eye"></i></button>
                           <button class="btn-pay" onclick="payWorker(${realIndex})">Bayar</button>`
                        : `<span style="color:green; font-size:0.8em;"><i class="fa-solid fa-check"></i> Selesai</span>`;
                    
                    let taskSummary = getTaskSummary(worker.tasks);

                    // DASHBOARD TABLE
                    tbodyDashboard.innerHTML += `<tr><td><b>${worker.name}</b><br><small>${worker.timestamp}</small></td><td>${worker.sector}</td><td>${taskSummary}</td><td style="font-weight:bold;">${formatRupiah(worker.salary)}</td><td>${statusBadge}</td><td>${actionButtons}</td></tr>`;

                    // HISTORY TABLE
                    tbodyHistory.innerHTML += `<tr><td>${worker.timestamp}</td><td>${worker.name}</td><td>${taskSummary}</td><td>${formatRupiah(worker.salary)}</td><td>${statusBadge}</td></tr>`;

                    // MAP GPS DOTS (Only for Pending)
                    if(worker.status === 'Pending'){
                        let top = '50%', left = '50%'; 
                        const rand = () => Math.floor(Math.random() * 20) - 10; 
                        if(worker.sector === "Sektor A") { top = (40 + rand()) + '%'; left = (20 + rand()) + '%'; }
                        else if(worker.sector === "Sektor B") { top = (20 + rand()) + '%'; left = (70 + rand()) + '%'; }
                        else if(worker.sector === "Sektor C") { top = (70 + rand()) + '%'; left = (70 + rand()) + '%'; }

                        const dot = document.createElement('div');
                        dot.className = 'worker-dot';
                        dot.style.top = top; dot.style.left = left;
                        dot.setAttribute('data-name', worker.name);
                        dot.innerHTML = '<i class="fa-solid fa-user"></i>';
                        mapContainer.appendChild(dot);
                    }
                });
            }
            document.getElementById('last-sync').innerText = "Live: " + new Date().toLocaleTimeString();
        }

        function openDetail(index) {
            const workers = JSON.parse(localStorage.getItem('agroDB'));
            const worker = workers[index];
            document.getElementById('modal-name').innerText = "Nama: " + worker.name;
            document.getElementById('modal-sector').innerText = "Lokasi: " + worker.sector;
            const gallery = document.getElementById('modal-gallery');
            gallery.innerHTML = ''; 
            if (worker.images && worker.images.length > 0) {
                worker.images.forEach(imgSrc => { gallery.innerHTML += `<img src="${imgSrc}" alt="Bukti Foto">`; });
            } else { gallery.innerHTML = '<p style="grid-column: span 3; text-align:center; color:gray;">Tidak ada foto.</p>'; }
            document.getElementById('detailModal').style.display = 'flex';
        }

        function payWorker(index) {
            let workers = JSON.parse(localStorage.getItem('agroDB'));
            if(confirm(`Bayar gaji sebesar ${formatRupiah(workers[index].salary)} kepada ${workers[index].name}?`)) {
                workers[index].status = 'Paid';
                localStorage.setItem('agroDB', JSON.stringify(workers));
                loadRealtimeData();
            }
        }

        function resetDB() { if(confirm("Hapus semua data?")) { localStorage.removeItem('agroDB'); loadRealtimeData(); } }

        function showPage(pageId, element) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(element) { document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active')); element.classList.add('active'); }
            const titles = { 'dashboard': 'Dashboard', 'map': 'Peta & GPS', 'cctv': 'Monitoring CCTV', 'finance': 'Keuangan', 'report': 'Laporan' };
            document.getElementById('page-title').innerText = titles[pageId];
        }

        setInterval(loadRealtimeData, 2000);
        loadRealtimeData();
    </script>
</body>
</html>